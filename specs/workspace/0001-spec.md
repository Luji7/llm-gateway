# 0001 - AI 网关代理服务（Anthropic -> OpenAI 兼容）需求与设计

**文档状态**: Draft
**版本**: v0.1
**目标读者**: 产品/架构/后端工程
**语言**: 中文

---

## 1. 背景与目标

### 1.1 背景
需要一个轻量级 AI 网关代理服务，接受 Anthropic Messages API 格式的请求，转换为 OpenAI Chat Completions 兼容格式，并转发至 OpenAI 兼容后端（如 OpenAI 官方或同协议的服务），再将响应转换回 Anthropic 的响应结构返回给调用方。

### 1.2 目标
- 提供一个 **Rust 实现的 REST 服务**，对外暴露 Anthropic Messages API 风格的接口。
- 完成 Anthropic -> OpenAI 兼容格式的 **请求转换** 与 **响应回传映射**。
- 支持 **非流式** 与 **SSE 流式** 两类响应。
- 尽量保持语义与字段兼容，并对无法直接映射的字段给出明确的处理策略。

### 1.3 非目标
- 不实现 Anthropic 或 OpenAI 的完整功能子集（如账户管理、批量任务、细粒度路由等）。
- 不承担模型路由、灰度、配额分发等高级网关能力。
- 不对接多供应商，默认单一 OpenAI 兼容后端。

---

## 2. 术语

- **Anthropic 格式**: 参见 `./specs/anthropic消息格式.md`
- **OpenAI 兼容格式**: 参见 `./specs/openai兼容格式.md`
- **上游**: 调用本服务的客户端（发送 Anthropic 格式）
- **下游**: OpenAI 兼容的模型服务

---

## 3. 功能需求

### 3.1 对外接口
- **URL**: `POST /v1/messages`
- **请求格式**: Anthropic Messages API 规范
- **响应格式**: Anthropic Messages API 规范
- **SSE 流式**: `stream=true` 时返回 Anthropic SSE 事件流

### 3.2 请求转换（Anthropic -> OpenAI）
将上游请求转换为 OpenAI Chat Completions 兼容格式，核心映射规则如下：

#### 3.2.1 顶层字段映射
| Anthropic 字段 | OpenAI 兼容字段 | 说明 |
| --- | --- | --- |
| model | model | 透传，允许配置映射表（可选） |
| messages | messages | 见 3.2.2 |
| system | messages[role=system] | Anthropic 无 system 角色，需注入 OpenAI 的 system/developer 消息 |
| max_tokens | max_completion_tokens | 以兼容形式传递 |
| temperature | temperature | 透传（注意 thinking 约束） |
| top_p | top_p | 透传 |
| stop_sequences | stop | 映射为 stop 数组 |
| stream | stream | 透传 |
| tools | tools | 结构映射，见 3.2.3 |
| tool_choice | tool_choice | 结构映射 |
| output_format | response_format | 结构映射，见 3.2.4 |
| thinking | reasoning_effort / response_format? | 不直接支持，见 3.2.5 |

#### 3.2.2 messages 映射
- Anthropic role 仅 user/assistant，需映射到 OpenAI role。
- Anthropic `content` 支持字符串或 content block 数组：
  - `text` block -> OpenAI `content` 文本或 `type: text`
  - `image` block -> OpenAI `type: image_url`，需将 base64 转换为 data URL
  - `document` block -> 若下游不支持 file_id，暂不支持或降级为文本（配置项）
  - `tool_result` block -> OpenAI `role=tool` 消息，`tool_call_id` 对应 `tool_use_id`
  - `tool_use` block -> OpenAI `assistant` 消息中的 `tool_calls`
  - `thinking` / `redacted_thinking` block -> OpenAI `reasoning_content`（如支持）或丢弃（可配置）

#### 3.2.3 工具定义映射
- Anthropic tools 格式 (name/description/input_schema) -> OpenAI tools.function 格式
- tool_choice: 
  - `auto` -> `auto`
  - `any` -> `auto`（无等价）
  - `tool` -> 指定 function name

#### 3.2.4 结构化输出映射
- Anthropic `output_format` -> OpenAI `response_format`:
  - `type: json` + schema -> `type: json_schema` + json_schema
  - `strict` 默认 true（可配置）

#### 3.2.5 Thinking 映射策略
- Anthropic `thinking` 为扩展思考模式；OpenAI 兼容的 `reasoning_content` 非完全等价。
- 默认策略：
  - 若下游为推理模型且支持 `reasoning_effort`，可根据 `thinking.budget_tokens` 映射为 `reasoning_effort=high`（或配置映射表）。
  - `thinking` block 在响应中如出现则尽力映射到 `reasoning_content`，否则丢弃。

### 3.3 响应转换（OpenAI -> Anthropic）
- 非流式：
  - `choices[0].message` -> Anthropic `content` block 数组
  - `finish_reason` -> `stop_reason` 映射：
    - `stop` -> `end_turn`
    - `length` -> `max_tokens`
    - `tool_calls` -> `tool_use`
    - `content_filter`/`refusal` -> `end_turn`（并将拒绝文本放入 content）
- usage 统计字段转换为 Anthropic usage（如可获得）
- tool_calls -> `tool_use` block
- reasoning_content -> `thinking` block（若存在）

### 3.4 流式响应转换
- 下游为 OpenAI SSE：`chat.completion.chunk` -> Anthropic SSE 事件流
- 需要组装 Anthropic 事件：
  - `message_start`
  - `content_block_start`
  - `content_block_delta`
  - `content_block_stop`
  - `message_delta`
  - `message_stop`
- 最终终止时向上游发送 `message_stop` 并关闭连接

### 3.5 错误处理
- 将下游错误转换为 Anthropic 错误结构：
  - HTTP 4xx/5xx -> Anthropic `error` 对象
  - 尽量映射 error.type（如 invalid_request_error, authentication_error, rate_limit_error, api_error）
- 对不可映射字段给出明确错误信息

---

## 4. 设计约束与兼容性

### 4.1 兼容策略
- 优先保持 Anthropic 输入输出结构一致，转换失败时返回 Anthropic 风格错误。
- 对下游不支持的内容（如 document/file）应提供配置化的降级策略：
  - `reject`（默认）
  - `strip`（丢弃该 block）
  - `text_only`（仅保留文本）

### 4.2 配置项
- OpenAI 下游地址（base url）
- OpenAI API key
- Anthropic -> OpenAI model 映射表（可选）
- 思考模式映射策略（thinking handling）
- 不支持内容的降级策略
- 超时、重试、最大并发

### 4.3 安全与合规
- 不记录明文 prompt（默认关闭日志脱敏）
- API key 仅从环境变量加载
- 支持请求 ID 透传与日志追踪

---

## 5. 系统架构

### 5.1 组件
- **HTTP Server (Rust)**: 接收 Anthropic 风格请求
- **Translator**: 请求/响应格式转换
- **HTTP Client**: 调用 OpenAI 兼容下游
- **SSE Proxy**: 处理流式响应的事件转换
- **Config**: 环境变量 + 配置文件

### 5.2 数据流
1. 客户端发送 Anthropic 请求到 `/v1/messages`
2. Translator 将请求转为 OpenAI Chat Completions
3. HTTP Client 请求下游
4. 响应回传：
   - 非流式：组装 Anthropic 响应 JSON
   - 流式：转换为 Anthropic SSE 事件流

---

## 6. API 设计细节

### 6.1 Endpoint
- `POST /v1/messages`
- Content-Type: `application/json`
- Header: 允许透传 `x-api-key`，但服务自身使用下游 API key

### 6.2 请求校验
- 必填字段：`model`, `messages`, `max_tokens`
- `messages` 内 role 必须为 `user` 或 `assistant`
- 当 `thinking` 启用时，`temperature` 必须为 1（若违反则返回 400）

### 6.3 响应字段
- 返回 Anthropic `message` 对象
- `usage` 字段尽量填充（若下游无数据则置 0）

---

## 7. 数据结构设计（Rust）

### 7.1 核心结构
- `AnthropicRequest`
- `AnthropicMessage`
- `AnthropicContentBlock`
- `OpenAIRequest`
- `OpenAIMessage`
- `OpenAIContentPart`
- `OpenAITool`
- `OpenAIResponse`

### 7.2 转换模块
- `anthropic_to_openai(req: AnthropicRequest) -> OpenAIRequest`
- `openai_to_anthropic(resp: OpenAIResponse) -> AnthropicResponse`
- `openai_stream_to_anthropic_sse(...)`

---

## 8. 关键映射规则（摘要）

### 8.1 role/system 规则
- Anthropic `system` -> OpenAI `messages[0]` with role `system`
- 如果目标模型是推理模型（需 developer），可配置替换为 `developer`

### 8.2 tool_calls 规则
- Anthropic `tool_use` -> OpenAI `tool_calls`
- Anthropic `tool_result` -> OpenAI `role=tool`

### 8.3 多模态规则
- Anthropic `image` -> OpenAI `image_url` with data URL
- Anthropic `document` -> 默认拒绝（可配置）

---

## 9. 运行与部署

### 9.1 运行方式
- 提供 `cargo run` 启动
- 监听地址默认 `0.0.0.0:8080`

### 9.2 环境变量
- `OPENAI_BASE_URL`
- `OPENAI_API_KEY`
- `MODEL_MAP`（可选，JSON）
- `THINKING_MODE`（可选）

---

## 10. 测试计划

### 10.1 单元测试
- 请求转换测试（多样例）
- 响应转换测试（普通 + 工具调用 + 推理 content）

### 10.2 集成测试
- 启动服务，使用 mock OpenAI 服务回放
- SSE 流式转换验证

---

## 11. 风险与开放问题

### 11.1 风险
- Thinking 与 reasoning_content 语义不等价
- 文档/文件多模态映射不完整
- SSE 事件流拼装复杂度

### 11.2 开放问题
- 是否需要支持 Anthropic `prompt-caching` header 转发
- 是否需要支持 OpenAI `stream_options` 与 usage
- 是否需要支持 OpenAI `response_format` strict 控制

---

## 12. 里程碑

- M1: 非流式请求/响应转换
- M2: SSE 流式转换
- M3: 工具调用与 structured outputs
- M4: 生产化配置与监控

